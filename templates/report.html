{% extends "base.html" %}
{% block title %}Report • Station Road{% endblock %}
{% block content %}

<!-- Header strip -->
<div class="sr-report-header mb-4 shadow-sm">
  <div class="row g-3 align-items-center">
    <div class="col-md">
      <div class="sr-eyebrow text-uppercase">Comparison Report</div>
      <h1 class="h4 mb-0">{{ header.address or "—" }}</h1>
      <div class="text-muted small mt-1">UPRN: {{ header.uprn or "—" }}</div>
    </div>
    <div class="col-auto text-end">
      <div class="sr-chip">PRE: {{ header.pre_date or "—" }}</div>
      <div class="sr-chip">POST: {{ header.post_date or "—" }}</div>
    </div>
  </div>
</div>

{% if header.notes %}
  <div class="alert alert-info shadow-sm">
    <strong>Notes:</strong><div class="mt-1">{{ header.notes }}</div>
  </div>
{% endif %}

<!-- KPI Grid -->
<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="sr-kpi card shadow-sm">
      <div class="card-body">
        <div class="sr-kpi-label">Current SAP</div>
        <div class="sr-kpi-values">
          <div><span class="sr-pill sr-pill-muted">PRE</span> {{ pre.summary.sap_current_band or "?" }} {{ pre.summary.sap_current or "?" }}</div>
          <div><span class="sr-pill sr-pill-success">POST</span> {{ post.summary.sap_current_band or "?" }} {{ post.summary.sap_current or "?" }}</div>
        </div>
        <div class="sr-kpi-delta {{ 'text-success' if diff.sap_change and diff.sap_change>0 else 'text-danger' if diff.sap_change and diff.sap_change<0 else 'text-muted' }}">
          Change: {{ diff.sap_change if diff.sap_change is not none else "—" }}
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="sr-kpi card shadow-sm">
      <div class="card-body">
        <div class="sr-kpi-label">Current EI</div>
        <div class="sr-kpi-values">
          <div><span class="sr-pill sr-pill-muted">PRE</span> {{ pre.summary.ei_current_band or "?" }} {{ pre.summary.ei_current or "?" }}</div>
          <div><span class="sr-pill sr-pill-success">POST</span> {{ post.summary.ei_current_band or "?" }} {{ post.summary.ei_current or "?" }}</div>
        </div>
        <div class="sr-kpi-delta {{ 'text-success' if diff.ei_change and diff.ei_change>0 else 'text-danger' if diff.ei_change and diff.ei_change<0 else 'text-muted' }}">
          Change: {{ diff.ei_change if diff.ei_change is not none else "—" }}
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="sr-kpi card shadow-sm">
      <div class="card-body">
        <div class="sr-kpi-label">Fuel Bill (est.)</div>
        <div class="sr-kpi-values">
          <div><span class="sr-pill sr-pill-muted">PRE</span> £{{ pre.summary.fuel_bill if pre.summary.fuel_bill is not none else "—" }}</div>
          <div><span class="sr-pill sr-pill-success">POST</span> £{{ post.summary.fuel_bill if post.summary.fuel_bill is not none else "—" }}</div>
        </div>
        <div class="sr-kpi-delta {{ 'text-success' if diff.fuel_bill_change and diff.fuel_bill_change<0 else 'text-danger' if diff.fuel_bill_change and diff.fuel_bill_change>0 else 'text-muted' }}">
          Change: {{ "{:+.1f}".format(diff.fuel_bill_change) if diff.fuel_bill_change is not none else "—" }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recommendations -->
<div class="card sr-card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="h5 mb-0">Recommendations</h2>
      <span class="badge bg-soft-primary text-primary">{{ diff.recs|length }} measures</span>
    </div>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>Measure</th>
            <th class="text-center">PRE</th>
            <th class="text-center">POST</th>
          </tr>
        </thead>
        <tbody>
          {% for name, row in diff.recs.items() %}
          <tr>
            <td class="fw-500">{{ name }}</td>
            <td class="text-center"><span class="sr-badge">{{ row.pre or "—" }}</span></td>
            <td class="text-center"><span class="sr-badge">{{ row.post or "—" }}</span></td>
          </tr>
          {% endfor %}
          {% if diff.recs|length == 0 %}
            <tr><td colspan="3" class="text-center text-muted">No recommendations detected.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    <div class="small text-muted">Tip: “Flat roof insulation” & “Room-in-roof insulation” must appear verbatim in the PDFs.</div>
  </div>
</div>

<!-- Areas -->
<div class="card sr-card shadow-sm">
  <div class="card-body">
    <h2 class="h5 mb-3">Key Areas (m²)</h2>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>Area</th>
            <th class="text-center">PRE</th>
            <th class="text-center">POST</th>
            <th class="text-center">Δ</th>
          </tr>
        </thead>
        <tbody>
          {% for label, vals in diff.areas.items() %}
          <tr>
            <td class="fw-500">{{ label }}</td>
            <td class="text-center">{{ vals.pre if vals.pre is not none else "—" }}</td>
            <td class="text-center">{{ vals.post if vals.post is not none else "—" }}</td>
            <td class="text-center fw-600 {{ 'text-success' if vals.delta and vals.delta>0 else 'text-danger' if vals.delta and vals.delta<0 else 'text-muted' }}">
              {{ "{:+.2f}".format(vals.delta) if vals.delta is not none else "—" }}
            </td>
          </tr>
          {% endfor %}
          {% if diff.areas|length == 0 %}
          <tr><td colspan="4" class="text-center text-muted">No area metrics detected.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    <div class="d-print-none mt-3 d-flex gap-2">
      <a href="/" class="btn btn-ghost">← Back</a>
      <form method="post" action="/pdf"><button class="btn btn-primary">Download PDF</button></form>
      <button class="btn btn-outline-primary" onclick="window.print()">Print</button>
    </div>
    <div class="text-center text-muted small mt-3">Use <em>Print → Save as PDF</em> for a branded export.</div>
  </div>
</div>

{% endblock %}
