{% extends "base.html" %}
{% block title %}EPC Comparison Report{% endblock %}
{% block content %}

<div class="page-head">
  <div>
    <h1>EPC Comparison Report</h1>
    <div class="muted small">
      Address: <strong>{{ header.address or '-' }}</strong>&nbsp; &nbsp; • &nbsp; UPRN: <strong>{{ header.uprn or 'Postcode' }}</strong>
      &nbsp; &nbsp; • &nbsp; PRE Date: {{ header.pre_date or '-' }} &nbsp; • &nbsp; POST Date: {{ header.post_date or '-' }}
    </div>
  </div>

  <div class="action-bar no-print">
    <a class="btn" href="/pdf" target="_blank" rel="noopener">Download PDF</a>
    <button class="btn primary" onclick="window.print()">Print / Save as PDF</button>
  </div>
</div>

{% if qa_flags and qa_flags|length > 0 %}
<div class="card info">
  <h2>QA Flags (Potential Input Errors)</h2>
  <ul class="list">
    {% for f in qa_flags %}
      <li>
        <span class="pill {{ 'danger' if f.level=='error' else ('warn' if f.level=='warning' else 'info') }}">{{ f.field }}</span>
        <span class="muted">—</span> {{ f.message }}
      </li>
    {% endfor %}
  </ul>
  <p class="muted">Automatic checks highlight PRE vs POST inconsistencies that commonly come from missed ticks or typos.</p>
</div>
{% endif %}

<div class="grid two">
  <div class="card">
    <h3>Current SAP</h3>
    <div class="row">
      <div>Band</div><div class="pill soft">{{ pre.summary.sap_current_band or '-' }}</div><div>Score</div><div class="pill">{{ pre.summary.sap_current or '-' }}</div>
    </div>
    <div class="row">
      <div>Band</div><div class="pill soft">{{ post.summary.sap_current_band or '-' }}</div><div>Score</div><div class="pill">{{ post.summary.sap_current or '-' }}</div>
    </div>
    <div class="row">
      <div>Change</div>
      <div class="pill success">{{ diff.sap_change if diff.sap_change is not none else '-' }}</div>
    </div>
  </div>

  <div class="card">
    <h3>Current EI</h3>
    <div class="row">
      <div>Band</div><div class="pill soft">{{ pre.summary.ei_current_band or '-' }}</div><div>Score</div><div class="pill">{{ pre.summary.ei_current or '-' }}</div>
    </div>
    <div class="row">
      <div>Band</div><div class="pill soft">{{ post.summary.ei_current_band or '-' }}</div><div>Score</div><div class="pill">{{ post.summary.ei_current or '-' }}</div>
    </div>
    <div class="row">
      <div>Change</div>
      <div class="pill success">{{ diff.ei_change if diff.ei_change is not none else '-' }}</div>
    </div>
  </div>
</div>

<div class="card">
  <h3>Fuel Bill (est.)</h3>
  <div class="row">
    <div>PRE</div><div class="pill">£{{ pre.summary.fuel_bill if pre.summary.fuel_bill is not none else '—' }}</div>
    <div>POST</div><div class="pill">£{{ post.summary.fuel_bill if post.summary.fuel_bill is not none else '—' }}</div>
    <div>Change</div>
    <div class="pill {{ 'danger' if diff.fuel_bill_change is not none and diff.fuel_bill_change>0 else 'success' }}">
      £{{ diff.fuel_bill_change if diff.fuel_bill_change is not none else '—' }}
    </div>
  </div>
</div>

<div class="grid two">
  <div class="card">
    <h3>Recommendations — Status Change</h3>
    <table class="table">
      <thead><tr><th>Measure</th><th>PRE</th><th>POST</th></tr></thead>
      <tbody>
      {% for name, vals in diff.recs.items() %}
        <tr>
          <td>{{ name }}</td>
          <td>{{ vals.pre or '-' }}</td>
          <td>{{ vals.post or '-' }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card">
    <h3>Key Areas (m²)</h3>
    <table class="table">
      <thead><tr><th>Area</th><th>PRE</th><th>POST</th><th>Δ</th></tr></thead>
      <tbody>
      {% for label, vals in diff.areas.items() %}
        <tr>
          <td>{{ label }}</td>
          <td>{{ '%.2f'|format(vals.pre) if vals.pre is not none else '-' }}</td>
          <td>{{ '%.2f'|format(vals.post) if vals.post is not none else '-' }}</td>
          <td>{{ '%.2f'|format(vals.delta) if vals.delta is not none else '-' }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if header.notes %}
<div class="card">
  <h3>Notes</h3>
  <p>{{ header.notes }}</p>
</div>
{% endif %}

{% endblock %}

